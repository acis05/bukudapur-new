{% extends "core/base.html" %}
{% load currency %}
{% block title %}Cash Flow â€” BukuDapur MBG{% endblock %}

{% block content %}
<div class="cardx p-4">
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="h3 mb-1">Cash Flow</div>
      <div class="muted">Kontrak: <b>{{ contract.name }}</b></div>
      <div class="muted">
        Cash Masuk = <b>Paid (penjualan)</b> + <b>Kas Masuk manual</b>.
        Cash Keluar = <b>Kas Keluar manual</b>.
        <span class="d-block">Catatan: Profit di Dashboard bisa beda dengan Kas (karena kredit/piutang).</span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-ghost" href="{% url 'dashboard' %}">Kembali</a>
      <a class="btn btn-accent" href="{% url 'cash_create' %}">+ Tambah Cash</a>
    </div>
  </div>

  <!-- Summary -->
  <div class="row g-3 mt-3">
    <div class="col-md-4">
      <div class="cardx p-3">
        <div class="muted small">Total Cash Masuk</div>
        <div class="h4 m-0">{{ total_in|rupiah }}</div>
        <div class="small muted mt-1">
          Paid penjualan: <b>{{ sales_cash_in|rupiah }}</b><br/>
          Kas masuk manual: <b>{{ manual_in|rupiah }}</b>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="cardx p-3">
        <div class="muted small">Total Cash Keluar</div>
        <div class="h4 m-0">{{ total_out|rupiah }}</div>
        <div class="small muted mt-1">
          Kas keluar manual: <b>{{ manual_out|rupiah }}</b>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="cardx p-3">
        <div class="muted small">Net Cash</div>
        <div class="h4 m-0">{{ net|rupiah }}</div>
        <div class="small muted mt-1">
          Piutang berjalan: <b>{{ ar_outstanding|rupiah }}</b>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive mt-3">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th style="min-width:110px;">Tanggal</th>
          <th style="min-width:120px;">Kategori</th>
          <th style="min-width:180px;">Catatan</th>
          <th class="text-end" style="min-width:120px;">Masuk</th>
          <th class="text-end" style="min-width:120px;">Keluar</th>
          <th class="text-end" style="min-width:140px;">Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for e in rows %}
          <tr>
            <td>{{ e.date|date:"d M Y" }}</td>
            <td>{{ e.category }}</td>
            <td class="muted">{{ e.notes|default:"-" }}</td>

            <td class="text-end">
              {% if e.flow == "IN" %}<b>{{ e.amount|rupiah }}</b>{% else %}-{% endif %}
            </td>
            <td class="text-end">
              {% if e.flow == "OUT" %}<b>{{ e.amount|rupiah }}</b>{% else %}-{% endif %}
            </td>

            <td class="text-end">
              <a class="btn btn-sm btn-nav" href="{% url 'cash_edit' e.id %}">Edit</a>

              <!-- DELETE harus POST (sesuai view cash_delete) -->
              <form method="post" action="{% url 'cash_delete' e.id %}" class="d-inline">
                {% csrf_token %}
                <button class="btn btn-sm btn-ghost"
                        type="submit"
                        onclick="return confirm('Hapus transaksi cash ini?');">
                  Hapus
                </button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="muted">Belum ada transaksi cash.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  /* Biar tabel nyaman di HP: bisa scroll horizontal, dan scroll terasa halus */
  .table-responsive { -webkit-overflow-scrolling: touch; }
</style>
{% endblock %}